<!DOCTYPE html>
<html>
<head>
  <style>
    html, body { background: none; margin: 0; padding: 0; height: 100%; }
  </style>
</head>
<body>
  <script src="https://unpkg.com/@rive-app/webgl2"></script>

  <canvas id="canvas" width="1920" height="1080"></canvas>

  <script src="https://libs.singular.live/singularwidget/1.0.3/singularwidget.js"></script>
  <script>
    let riveProps = {};

    // Collect all Rive property accessors from all view models
    function GetAllViewModelProperties(rive) {
      const props = {};
      
      console.log(`üîç Found ${rive.viewModelCount} view model(s) in Rive file`);
      
      // Iterate through all view models
      for (let i = 0; i < rive.viewModelCount; i++) {
        const viewModel = rive.viewModelByIndex(i);
        if (!viewModel) {
          console.warn(`‚ö†Ô∏è ViewModel ${i} is null/undefined`);
          continue;
        }
        
        console.log(`üìã Processing ViewModel ${i}: ${viewModel.name || 'Unnamed'}`);
        
        // Get the default instance of this view model
        const vmi = viewModel.defaultInstance();
        if (!vmi) {
          console.warn(`‚ö†Ô∏è No default instance found for ViewModel ${i}`);
          continue;
        }

        const properties = viewModel.properties;
        if (!properties || !properties.length) {
          console.warn(`‚ö†Ô∏è No properties found in ViewModel ${i}`);
          continue;
        }

        for (const property of properties) {
          if (!property || !property.name) continue;
          let accessor = null;

          switch(property.type) {
            case "string":   accessor = vmi.string(property.name); break;
            case "number":   accessor = vmi.number(property.name); break;
            case "boolean":  accessor = vmi.boolean(property.name); break;
            case "trigger":  accessor = vmi.trigger(property.name); break;
            default: break;
          }

          if (accessor) {
            // Add to global props using original property name
            props[property.name] = { type: property.type, accessor };
            console.log(`  ‚úÖ Added property: ${property.name} (${property.type}) from VM${i}`);
          }
        }
      }
      
      console.log("‚úÖ Collected all Rive properties:", props);
      return props;
    }

    // Initialize Rive
    const r = new rive.Rive({
      src: "test_file.riv",
      canvas: document.getElementById("canvas"),
      autoplay: true,
      autoBind: true,
      stateMachines: "State Machine 1",
      onLoad: () => {
        console.log("‚úÖ Rive loaded");
        r.resizeDrawingSurfaceToCanvas();
        
        // Check for view models
        if (r.viewModelCount === 0) {
          console.error("‚ùå No ViewModels found in Rive file");
          return;
        }

        riveProps = GetAllViewModelProperties(r);
        
        // Log UI definition on console log for now
        generateModelForManualSetup();
      },
    });

    // Generate model structure for manual setup in SingularLive
    function generateModelForManualSetup() {
      const fields = [];
      const groups = [];

      // Create fields based on Rive properties
      for (const [name, prop] of Object.entries(riveProps)) {        
        const field = {
          id: name,
          type: prop.type === "trigger" ? "button" : prop.type === "string" ? "text" : prop.type,
          title: name.charAt(0).toUpperCase() + name.slice(1),
          defaultValue: prop.type === "trigger" ? "" : prop.accessor.value || (prop.type === "number" ? 0 : prop.type === "boolean" ? false : "")
        };
        fields.push(field);
      }

      // Create a single group if we have fields
      if (fields.length > 0) {
        groups.push({
          id: "riveControlsGroup",
          title: "Rive Controls",
          width: "double",
          toolTip: "Control your Rive animation properties",
          childIds: fields.map(f => f.id)
        });
      }

      const model = { model: { fields, groups } };

      console.log("\nüìã COPY THIS JSON TO WIDGET MANAGER UI DEFINITION:");
      console.log("=" + "=".repeat(60));
      console.log(JSON.stringify(model, null, 2));
      console.log("=" + "=".repeat(60));
    }

    // Initialize SingularWidget
    SingularWidget.init({
      onInit: onSingularInit,
      onValue: onSingularValue,
      onButtonClicked: onSingularButtonClicked,
      onEditComp: onSingularEditComp,
    });

    function onSingularInit() {
      console.log("onSingularInit");
    }

    function onSingularValue(json) {
      console.log("onSingularValue", json);

      for (const [name, prop] of Object.entries(riveProps)) {
        if (json[name] === undefined) continue;

        try {
          if (prop.type === "string") {
            prop.accessor.value = json[name];
            console.log(`üìù Updated string '${name}' to:`, json[name]);
          } 
          else if (prop.type === "number") {
            prop.accessor.value = parseFloat(json[name]);
            console.log(`üî¢ Updated number '${name}' to:`, prop.accessor.value);
          } 
          else if (prop.type === "boolean") {
            prop.accessor.value = !!json[name];
            console.log(`üü¢ Updated boolean '${name}' to:`, prop.accessor.value);
          }
        } catch (err) {
          console.error(`‚ùå Failed to update property '${name}':`, err);
        }
      }
    }

    function onSingularButtonClicked(action) {
      console.log("onSingularButtonClicked", action);

      const prop = riveProps[action];
      if (prop && prop.type === "trigger") {
        if (typeof prop.accessor.trigger === "function") prop.accessor.trigger();
        console.log(`üöÄ Triggered '${action}'`);
      } else {
        console.warn(`‚ö†Ô∏è No trigger found for '${action}'`);
      }


    }

    function onSingularEditComp(comp) {
      console.log("onSingularEditComp", comp);
    }
    
  </script>
</body>
</html>
